/**
 * Script Writer Agent
 * Main engine for generating Arabic (GCC dialect) video scripts
 */

import { AzureOpenAI } from '@azure/openai';
import dotenv from 'dotenv';
import { MarketUpdateTemplate } from '../templates/market-update.js';
import { EducationTemplate } from '../templates/education.js';
import { TermsTemplate } from '../templates/terms.js';
import { DualAvatarTemplate } from '../templates/dual-avatar.js';
import { ArabicValidator } from '../utils/arabic-validator.js';
import { WordCounter } from '../utils/word-counter.js';
import { ComplianceChecker } from '../utils/compliance-checker.js';

dotenv.config();

export class ScriptWriter {
  constructor() {
    this.client = new AzureOpenAI({
      apiKey: process.env.AZURE_OPENAI_API_KEY,
      endpoint: process.env.AZURE_OPENAI_ENDPOINT,
      apiVersion: process.env.AZURE_OPENAI_API_VERSION || '2025-01-01-preview'
    });

    this.deployment = process.env.AZURE_OPENAI_DEPLOYMENT || 'gpt-5';

    this.templates = {
      'monday': MarketUpdateTemplate,
      'tuesday': EducationTemplate,
      'wednesday': TermsTemplate,
      'thursday': MarketUpdateTemplate, // Crypto & Commodities variant
      'friday': MarketUpdateTemplate, // Weekly Outlook variant
      'saturday': EducationTemplate, // Community Q&A variant
      'sunday': EducationTemplate, // Trading Psychology variant
      'dual': DualAvatarTemplate
    };
  }

  /**
   * Get template for day of week
   * @param {string} day - Day of week or template name
   * @returns {Object} Template class
   */
  getTemplate(day) {
    const dayLower = day.toLowerCase();
    return this.templates[dayLower] || MarketUpdateTemplate;
  }

  /**
   * Generate script using Azure OpenAI GPT-5
   * @param {Object} options - Script generation options
   * @returns {Object} Generated script with metadata
   */
  async generateScript(options = {}) {
    const {
      day = 'monday',
      persona = 'Fatima',
      topic = null,
      customPrompt = null,
      maxRetries = 3
    } = options;

    console.log(`\nüé¨ Generating script for ${day}...`);
    console.log(`üìù Persona: ${persona}`);

    const TemplateClass = this.getTemplate(day);
    const systemPrompt = TemplateClass.getSystemPrompt({ persona, ...options });
    const userPrompt = customPrompt || TemplateClass.getUserPrompt(options);

    let attempt = 0;
    let bestScript = null;
    let bestScore = 0;

    while (attempt < maxRetries) {
      attempt++;
      console.log(`\nüîÑ Attempt ${attempt}/${maxRetries}...`);

      try {
        const response = await this.client.chat.completions.create({
          model: this.deployment,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userPrompt }
          ],
          temperature: 0.7,
          max_tokens: 1000,
          top_p: 0.9,
          frequency_penalty: 0.3,
          presence_penalty: 0.3
        });

        const scriptText = response.choices[0].message.content.trim();

        // Validate the generated script
        const validation = await this.validateScript(scriptText);

        console.log(`\nüìä Validation Results:`);
        console.log(`   Word Count: ${validation.wordCount.wordCount} (target: 180-220)`);
        console.log(`   GCC Dialect Score: ${validation.arabic.dialect.score}/100`);
        console.log(`   Compliance: ${validation.compliance.isCompliant ? '‚úÖ' : '‚ùå'}`);

        // Calculate overall score
        const score = this.calculateScore(validation);
        console.log(`   Overall Score: ${score}/100`);

        if (score > bestScore) {
          bestScore = score;
          bestScript = {
            script_ar: scriptText,
            persona,
            template: TemplateClass.metadata.name,
            dayOfWeek: day,
            validation,
            score,
            attempt
          };
        }

        // If score is good enough, stop retrying
        if (score >= 80) {
          console.log(`\n‚úÖ Excellent script generated (score: ${score}/100)`);
          break;
        }

      } catch (error) {
        console.error(`‚ùå Error in attempt ${attempt}:`, error.message);
        if (attempt === maxRetries) {
          throw error;
        }
      }
    }

    if (!bestScript) {
      throw new Error('Failed to generate valid script after all retries');
    }

    // Add compliance fixes if needed
    if (!bestScript.validation.compliance.isCompliant) {
      console.log(`\nüîß Applying compliance fixes...`);
      bestScript.script_ar = ComplianceChecker.addRiskWarning(bestScript.script_ar);
      bestScript.validation.compliance = ComplianceChecker.checkCompliance(bestScript.script_ar);
    }

    // Add metadata
    const stats = WordCounter.getStatistics(bestScript.script_ar);
    bestScript.duration_seconds = stats.estimatedDuration;
    bestScript.word_count = stats.wordCount;
    bestScript.compliance_verified = bestScript.validation.compliance.isCompliant;

    console.log(`\nüéâ Final script ready!`);
    console.log(`   Duration: ${bestScript.duration_seconds}s`);
    console.log(`   Words: ${bestScript.word_count}`);
    console.log(`   Compliance: ${bestScript.compliance_verified ? '‚úÖ' : '‚ùå'}`);

    return bestScript;
  }

  /**
   * Validate generated script
   * @param {string} scriptText - Script text to validate
   * @returns {Object} Validation results
   */
  async validateScript(scriptText) {
    const wordCount = WordCounter.validateWordCount(scriptText);
    const arabic = ArabicValidator.validate(scriptText);
    const compliance = ComplianceChecker.checkCompliance(scriptText);

    return {
      wordCount,
      arabic,
      compliance,
      isValid: wordCount.isValid && arabic.isValid && compliance.isCompliant
    };
  }

  /**
   * Calculate overall script quality score
   * @param {Object} validation - Validation results
   * @returns {number} Score from 0-100
   */
  calculateScore(validation) {
    let score = 0;

    // Word count (30 points)
    if (validation.wordCount.isValid) {
      score += 30;
    } else {
      const wordCount = validation.wordCount.wordCount;
      const min = validation.wordCount.minWords;
      const max = validation.wordCount.maxWords;
      const distance = Math.min(
        Math.abs(wordCount - min),
        Math.abs(wordCount - max)
      );
      score += Math.max(0, 30 - distance); // Deduct 1 point per word off
    }

    // Arabic GCC dialect (40 points)
    score += Math.min(40, validation.arabic.dialect.score * 0.4);

    // Compliance (30 points)
    if (validation.compliance.isCompliant) {
      score += 30;
    } else {
      if (validation.compliance.riskWarning.isCompliant) score += 15;
      if (validation.compliance.cta.isCompliant) score += 10;
      if (validation.compliance.balance.isBalanced) score += 5;
    }

    return Math.round(score);
  }

  /**
   * Generate weekly batch of scripts (7 days)
   * @param {Object} options - Batch generation options
   * @returns {Array} Array of 7 scripts
   */
  async generateWeeklyBatch(options = {}) {
    const { persona = 'Fatima', brand = 'Seekapa' } = options;

    console.log(`\nüìÖ Generating weekly batch of scripts...`);
    console.log(`   Persona: ${persona}`);
    console.log(`   Brand: ${brand}\n`);

    const weeklyTopics = {
      monday: {
        topic: 'ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ÿ≥ŸàÿßŸÇ - ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÜŸáÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ',
        keyPoints: [
          'ÿ£ÿØÿßÿ° ÿßŸÑÿØŸàŸÑÿßÿ± ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸä',
          'ÿ™ÿ≠ÿ±ŸÉÿßÿ™ ÿßŸÑÿ∞Ÿáÿ® ŸàÿßŸÑŸÜŸÅÿ∑',
          'ÿßŸÑÿ£ÿ≥ŸàÿßŸÇ ÿßŸÑÿ¢ÿ≥ŸäŸàŸäÿ© ŸàÿßŸÑÿ£Ÿàÿ±Ÿàÿ®Ÿäÿ©'
        ]
      },
      tuesday: {
        topic: 'ŸÉŸäŸÅ ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÇŸÅ ÿßŸÑÿÆÿ≥ÿßÿ±ÿ© ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠',
        steps: [
          'ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿØÿÆŸàŸÑ',
          'ÿ≠ÿ≥ÿßÿ® ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ±ÿ©',
          'Ÿàÿ∂ÿπ ŸàŸÇŸÅ ÿßŸÑÿÆÿ≥ÿßÿ±ÿ© ÿπŸÜÿØ ŸÖÿ≥ÿ™ŸàŸâ ŸÖŸÜÿ∑ŸÇŸä'
        ]
      },
      wednesday: {
        term: 'ÿßŸÑÿ±ÿßŸÅÿπÿ© ÿßŸÑŸÖÿßŸÑŸäÿ©',
        termEnglish: 'Leverage',
        simpleDefinition: 'ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ŸÖŸàÿßŸÑ ŸÖŸÇÿ™ÿ±ÿ∂ÿ© ŸÑÿ≤ŸäÿßÿØÿ© ŸÇŸàÿ© ÿßŸÑÿ™ÿØÿßŸàŸÑ'
      },
      thursday: {
        topic: 'ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉÿ±Ÿäÿ®ÿ™Ÿà ŸàÿßŸÑÿ≥ŸÑÿπ',
        keyPoints: [
          'ÿ®Ÿäÿ™ŸÉŸàŸäŸÜ Ÿàÿ≠ÿ±ŸÉÿ© ÿßŸÑÿπŸÖŸÑÿßÿ™ ÿßŸÑÿ±ŸÇŸÖŸäÿ©',
          'ÿßŸÑÿ∞Ÿáÿ® ŸàÿßŸÑŸÅÿ∂ÿ©',
          'ÿßŸÑŸÜŸÅÿ∑ ŸàÿßŸÑÿ∫ÿßÿ≤ ÿßŸÑÿ∑ÿ®ŸäÿπŸä'
        ]
      },
      friday: {
        topic: 'ÿ™ŸàŸÇÿπÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑŸÇÿßÿØŸÖ',
        keyPoints: [
          'ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸäÿ© ÿßŸÑŸÖŸáŸÖÿ©',
          'ÿßŸÑŸÅÿ±ÿµ ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑÿ©',
          'ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿßŸÑÿ™Ÿä Ÿäÿ¨ÿ® ŸÖÿ±ÿßŸÇÿ®ÿ™Ÿáÿß'
        ]
      },
      saturday: {
        topic: 'ÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ¨ÿ™ŸÖÿπ - ŸÉŸäŸÅ ÿ£ÿ®ÿØÿ£ ÿßŸÑÿ™ÿØÿßŸàŸÑÿü',
        steps: [
          'ÿ™ÿπŸÑŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿßÿ™ ÿ£ŸàŸÑÿßŸã',
          'ÿßŸÅÿ™ÿ≠ ÿ≠ÿ≥ÿßÿ® ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä',
          'ÿ™ÿØÿ±ÿ® ŸÑŸÖÿØÿ© 3 ÿ£ÿ¥Ÿáÿ± ŸÇÿ®ŸÑ ÿßŸÑŸÖÿßŸÑ ÿßŸÑÿ≠ŸÇŸäŸÇŸä'
        ]
      },
      sunday: {
        topic: 'ÿπŸÑŸÖ ŸÜŸÅÿ≥ ÿßŸÑÿ™ÿØÿßŸàŸÑ - ÿßŸÑÿ≥Ÿäÿ∑ÿ±ÿ© ÿπŸÑŸâ ÿßŸÑÿπŸàÿßÿ∑ŸÅ',
        steps: [
          'ÿ™ÿ≠ÿØŸäÿØ ÿÆÿ∑ÿ© Ÿàÿßÿ∂ÿ≠ÿ©',
          'ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ ÿ®ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ±',
          'ÿπÿØŸÖ ÿßŸÑÿ™ÿØÿßŸàŸÑ ÿßŸÑÿπÿßÿ∑ŸÅŸä'
        ]
      }
    };

    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const scripts = [];

    for (const day of days) {
      try {
        const script = await this.generateScript({
          day,
          persona,
          brand,
          ...weeklyTopics[day]
        });
        scripts.push(script);
        console.log(`\n‚úÖ ${day} script completed\n`);

        // Small delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 1000));
      } catch (error) {
        console.error(`\n‚ùå Failed to generate ${day} script:`, error.message);
        scripts.push({
          day,
          error: error.message,
          failed: true
        });
      }
    }

    console.log(`\nüéâ Weekly batch complete: ${scripts.filter(s => !s.failed).length}/7 successful`);
    return scripts;
  }

  /**
   * Generate single script by template name
   * @param {string} templateName - Template identifier
   * @param {Object} data - Template-specific data
   * @returns {Object} Generated script
   */
  async generateByTemplate(templateName, data = {}) {
    const TemplateClass = this.getTemplate(templateName);
    const systemPrompt = TemplateClass.getSystemPrompt(data);
    const userPrompt = TemplateClass.getUserPrompt(data);

    return this.generateScript({
      customPrompt: userPrompt,
      ...data
    });
  }
}

// CLI interface
if (import.meta.url === `file://${process.argv[1]}`) {
  const writer = new ScriptWriter();

  console.log('üé¨ Seekapa/Axia Script Writer Engine');
  console.log('=====================================\n');

  // Example: Generate Monday market update
  try {
    const script = await writer.generateScript({
      day: 'monday',
      persona: 'Fatima',
      brand: 'Seekapa',
      topic: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ÿ≥ŸàÿßŸÇ ÿ®ÿπÿØ ŸÜŸáÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ',
      keyPoints: [
        'ÿßŸÑÿØŸàŸÑÿßÿ± ÿßÿ±ÿ™ŸÅÿπ 0.5% ŸÖŸÇÿßÿ®ŸÑ ÿßŸÑŸäŸàÿ±Ÿà',
        'ÿßŸÑÿ∞Ÿáÿ® ÿßÿ≥ÿ™ŸÇÿ± ÿπŸÜÿØ 1850 ÿØŸàŸÑÿßÿ±',
        'ÿßŸÑŸÜŸÅÿ∑ ÿßŸÜÿÆŸÅÿ∂ ÿ•ŸÑŸâ 75 ÿØŸàŸÑÿßÿ±'
      ],
      newsEvent: 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™Ÿàÿ∏ŸäŸÅ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ© ÿßŸÑŸÇŸàŸäÿ©',
      insight: 'ÿ™ŸàŸÇÿπÿßÿ™ ÿ®ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ŸÇŸàÿ© ÿßŸÑÿØŸàŸÑÿßÿ± Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ'
    });

    console.log('\n' + '='.repeat(60));
    console.log('üìÑ GENERATED SCRIPT');
    console.log('='.repeat(60));
    console.log(script.script_ar);
    console.log('='.repeat(60));
    console.log(`\n‚úÖ Script saved to output\n`);

    // Save to file (optional)
    // fs.writeFileSync('./output/monday-script.json', JSON.stringify(script, null, 2));

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

export default ScriptWriter;
